\documentclass[a4paper,openany]{book}

\usepackage{config/bind}
\input{config/markets/commands.tex}

\newcommand\baileyWell{
  \noindent
  \begin{minipage}{\linewidth}
  \begin{speechtext}
    \hspace{3em}\flourish~{\scshape\Large Well}~\flourish
    \par
    \ifodd\value{r12}
      Proper \showTemperature\ today.
    \fi
    \ifodd\value{r3}
    \else
      \rotatebox{\value{rn1t2}}{Remember and buy some rope.}
      \rotatebox{\value{rn1t2}}{If you don' have it, you'll need it.}
    \fi

    \flushright
    \ifodd\day
      \footnotesize
      Why don't the \glspl{guard} make weapons?
      Why do they have to buy them from the \glspl{sunGuard}?
    \else
      My son's in the \gls{guard}.
      He kills \pgls{basilisk} a week, but never sends money home.
    \fi
    \normalsize\rm\centering
    \par
    {\sl
    \ifcase\thecycle
      Last week, out with the traders, I heard this little bell from the forest.
      Want to know where it was?
    \or
      \Gls{sable} can go fuck an icicle.
      What kind of god makes snow and just lies in it?
      `Lazy', that's what he is.
    \or
      Warming up, yes, indeed.
      Listen well and you can almost hear the \glspl{basilisk} waking from hibernation.
    \or
      Do you think the water tastes funny?
      Once my ale's done, it'll taste bloody hilarious!
    \or
      \ifodd\thefenestraDay
        Don't bump the watermelons with the bucket, or they'll go bad.
        Come back tonight, and you can have one.
      \else
        I know exactly why \gls{sylf} hates everyone.
        I'm three \glspl{cycle} pregnant, and not up for nothing.
        What do you think of `\composeHumanName' as a name?
      \fi
    \else
      Another year comes to an end.
      Good bloody riddance!
      \thefenestraYear\ was bad for \ifodd\year carrots\else barley\fi, and bad for \ifodd\thefenestraDay wine\else beets\fi.
    \fi
    }
    \ifodd\thefenestraDay%
      {\tiny When I grow up, I'll be \pgls{guard}.}
    \fi
  \end{speechtext}
  \end{minipage}
}

\newcommand\baileydesc{}
\newcommand\baileymarkets{}
\newcommand\baileymarketsWide{\baileyFletcher\par}
\newcommand\baileyback{}

\newcommand\genBailey{%
  \ifcase\value{r6}\relax\or%
    \appto{\name}{copper}%
    \appto{\baileydesc}{Copper spikes crown the outer wall.  }%
    \appto{\baileymarketsWide}{\baileyArms}%
  \or%
    \ifodd\thefenestraDay
      \appto{\name}{what}%
      \appto{\baileydesc}{The local \gls{doula} did not appreciate the \gls{village}'s original name, so people changed it to `what'.  }%
    \else
      \appto{\name}{kettle}%
      \appto{\baileydesc}{A wattle cottage stands awkwardly far from \baileyname's walls, beyond the farmland, in a sea of \ifnum\thecycle>3 daffodils\else thorns\fi.  }%
    \fi
    \appto{\baileymarkets}{\doulaCottage}%
  \or%
    \appto{\name}{nut}%
    \appto{\baileydesc}{Walnut tree grow around the farmland in a grand circle.
    They say walnuts keep the \gls{edge} at bay.  }%
    \renewcommand\rations{walnut cake}
    \appto{\baileymarketsWide}{}
  \or%
    \appto{\name}{stank}%
    \appto{\baileydesc}{You can smell the local peatbog from a mile away.  }%
    \appto{\baileymarketsWide}{\baileyTanner}%
  \or%
    \appto{\name}{broch}%
    \appto{\baileydesc}{The \gls{village} retains the \gls{broch} which founded the area, though nowadays a retired \gls{ranger} lives there.  }%
    \appto{\baileymarketsWide}{\baileyRanger\par}
  \or%
    \appto{\name}{mill}%
    \appto{\baileydesc}{%
      \ifodd\thediceNo%
        A windmill stands at the side, with an old woman watching your approach from a window.
      \else%
        A small watermill turns gently in the river.
      \fi%
    }%
    \ifnum\value{r12}=9
      \appto{\baileyback}{%
        The mill screams in the darkness.

        \paragraph{Rush through the dark while the miller family remains safe behind their bedroom door,}
        with \roll{Wits}{Athletics} at \tn[9].

        \paragraph{If the creature enters the door,}
        it kills, then retreats with the corpse.
        Chasing it down requires a \roll{Speed}{Athletics} check at \tn[10].

        \ifnum\thetemperature>1
          \chitincrawler
        \else
          \woodspy
        \fi
      }
    \fi
  \or%
    \appto{\name}{trapper}%
    \appto{\baileydesc}{The farmers remind everyone not to `skulk', as the outer fields have bear-traps hidden where you least expect them.  Every farmer here has a good memory.  }%
    \appto{\baileymarketsWide}{\baileyRanger\par}
  \else%
    \appto{\name}{quarry}%
    \appto{\baileydesc}{Half of the settlement is made from stone.  }%
    \appto{\baileymarketsWide}{\baileySmith}%
  \fi%
  \appto{\baileymarkets}{\par}%
  \addtocounter{r6}{\value{r2}}
}

%%%% The daily bailey  must have text on both sides of the page, so people can
%    orient themselves by it when printing booklets.

\newcommand\afterBaileyEvent{%
  \ifcase\value{r6}\relax%
  \or% 1
    \appto{\baileyback}{%
      The next evening, people with long, pointed ears arrive from beyond the \gls{edge} to sell.

      \gnollSellers

      \gnollDogShow
    }%
  \or% 2
    \ifnum\thetemperature>1
      \appto{\baileyback}{%
        That night, \pgls{crawler} arrives, climbs over the wall, and feels around the houses for an opening.
        Everyone remains still, and by the morning, it leaves.

        \chitincrawler
      }%
    \else%
      \appto{\baileyback}{%
        That night, \pgls{woodspy} arrives, climbs over the wall, and feels around the houses for an opening.
        \ifodd\thefenestraDay
          It leaves soon after, silently, but \baileyname\ remains worried the entire morning.
        \else
          It camouflages into a roof, silently, and waits for the right moment to strike.
        \fi
        \woodspy
      }%
    \fi
  \or% 3
    \appto{\baileyback}{%
      The night passes peacefully.
      Morning arrives with a \showTemperature\ wind.
      A small caravan arrive soon after.
      \composeHumanName\ sells \rations, \rations, and clothes.
      And \composeHumanName\ is happy to buy any \gls{ingredient} for \mkPrice{7}.
    }%
  \or% 4
    \appto{\baileyback}{%
      In the dark, two little lights pass quietly between houses; two young people have crept out to meet each other in secret, and everyone in \baileyname\ pretends not to hear them.
    }%
  \or% 5
    \appto{\baileyback}{%
      The next afternoon, bandits arrive at \baileyname, with \pgls{woodspy} corpse, claiming to be \glspl{guard}.
      This group began as \glspl{fodder} recently, then fled their post, killed their \gls{jotter}, gathered more, and marched a long way here hoping to go unnoticed.
      They still have their black clothing, but know nothing about the local \glspl{guard}.

      If the troupe push their claim, they become irritable, then leave and plan \pgls{ambush} (they don't want the \glspl{pc} telling everyone where they are).

      \humansoldier[\npc{\T[\arabic{r12}]\Hu}{\arabic{noAppearing}~`\Glspl{gDigger}'}]

      \composeHumanName\ speaks for the group, with her
      \ifodd\value{r4b}%
        high-pitched voice%
      \else%
        habit of stamping her feet for immediate attention%
      \fi, and
      \ifodd\value{r4}%
        acne-scarred nose.
      \else%
        weird milky-white eye.
      \fi%

      \ifodd\thefenestraYear
        \humanarcher[\npc{\T[\arabic{r12}]\Hu}{\arabic{noAppearing}~Hiding Bandits}]
      \else
        \humanthief[\npc{\T[\value{r12}]\Hu}{\arabic{noAppearing}~Hiding Bandits}]
      \fi

      \composeHumanName\ does the planning, from the back, while the rest constantly undermine his decisions.
    }%
  \else% 6
    \ifnum\thefenestraDay>50
      \appto{\baileyback}{%
        The next day, everyone in \baileyname\ begins fussing about the impending \gls{storm}.
        They discuss the rooves, possible flooding, and the possibility of placing buckets of water to prepare for lightning strikes setting something on fire.

        Attempting any further business takes two \glspl{interval}.
      }%
    \else
      \appto{\baileyback}{%
        \begin{boxtext}
          Long after Sunset, a trader's voice booms out from beyond the wall.
          He states his prices for ropes and meats, then stops half-way through the sentence.
          Another shouts their prices for clothes.
          The voices repeat their clipped phrases, always identically.
        \end{boxtext}

        If the \glspl{griffin} see one or two people out, they attack.
        Otherwise, they fly away.

        Everyone in \baileyname\ knows that \glspl{griffin} mimic human voices.
        The next day everyone has theories about which trader's voice they heard last night, and what has happened to them now.%
        \ifodd\value{r3b}%
          \footnote{The traders are fine.}%
        \else%
          \footnote{The traders lie dead \arabic{r12} miles up the \glsentrytext{lonelyRoad}.}%
        \fi%

        \griffin[\npc{\T[\value{r2t4}]\A}{\arabic{r2t4}~\Glspl{griffin}}]
      }%
    \fi
  \fi%
}

%%%%% Make the Random Bailey %%%%%

\randomize
\randomize
\randomize

\ifodd\value{r12}
  \stepcounter{diceNo}
\fi

\genBailey
\addtocounter{r6}{\value{r2}}
\genBailey

\appto{\baileymarkets}{%
  \baileyServices\par%
  \baileyHospitality\par%
  \baileySalvage\par%
}
% Baileys without a river should have a well.
\ifodd\thediceNo
  \appto{\baileymarkets}{\baileyWell}
\else
  \ifodd\value{r4b}
    \appto{\baileydesc}{Men are fixing boats by the shallow river.  One introduces himself as `\marketBoatman'.  }
  \else
    \appto{\baileydesc}{A deep river run through a wicker fence in the wall.  }
  \fi
\fi

\appto{\baileymarkets}{%
  \butcherStall\par%
  \baileyWeaver\par%
}

\edef\baileyname{\expandafter\MakeUppercase\name}

\afterBaileyEvent

\begin{document}

\frontmatter

\pagestyle{empty}

\section*{\baileyname}

\baileydesc

All purchases require a full morning or afternoon.
Farmers chat, then barter, and finally refer the buyer to a neighbour.

\begin{multicols}{3}

\baileymarkets

\end{multicols}

\begin{multicols}{2}

\baileymarketsWide

\end{multicols}

\vfill
{\hfill\sffamily After the night falls\ldots}

\clearpage

\begin{multicols}{2}

\baileyback

\end{multicols}

\end{document}
